<?php// File: modules/curriculum/update_module_content.php// — SORU/QUIZ ENTEGRASYONU + EXPLANATION —// - Yeni "question" içerikleri ekler: questions tablosuna yazar (explanation dahil), module_contents'e 'quiz' olarak bağlar// - Var olan 'quiz' içeriklerini günceller (explanation dahil)// - Silinen 'quiz' satırlarının bağlı questions kaydını da siler// - YouTube/text/video/doc mantığı korunursession_start();if (!isset($_SESSION['team_logged_in'])) { header('Location: ../team-login.php'); exit(); }$projectRoot = $_SERVER['DOCUMENT_ROOT']; // .../projeadirequire_once('../config.php');$pdo = get_db_connection();// ==== Ayarlar ====const DELETE_OLD_FILES_ON_REPLACE = true;   // yeni dosya yüklenince eskisini silconst DELETE_FILES_ON_ROW_DELETE  = true;   // içerik satırı silinince dosyayı da sil (yalnızca local uploads)// ---- Helpers ----function fail($msg, $code = 400) { http_response_code($code); die($msg); }function ensure_dir(string $path): void {    if (is_dir($path)) return;    if (!@mkdir($path, 0775, true) && !is_dir($path)) {        throw new RuntimeException("mkdir_failed: $path");    }}function sanitize_filename(string $name): string {    $name = iconv('UTF-8', 'ASCII//TRANSLIT//IGNORE', $name);    $name = preg_replace('/[^A-Za-z0-9_\.-]/', '_', $name);    return trim($name, '._');}function detect_mime(string $tmpPath): string {    $finfo = new finfo(FILEINFO_MIME_TYPE);    return $finfo->file($tmpPath) ?: 'application/octet-stream';}function is_allowed_mime(string $mime, string $kind): bool {    $video = [        'video/mp4','video/quicktime','video/x-msvideo','video/x-matroska','video/webm','video/ogg'    ];    $docs  = [        'application/pdf',        'application/msword',        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',        'application/vnd.ms-powerpoint',        'application/vnd.openxmlformats-officedocument.presentationml.presentation',        'application/vnd.ms-excel',        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'    ];    if ($kind === 'video') return in_array($mime, $video, true) || str_starts_with($mime, 'video/');    if ($kind === 'document') return in_array($mime, $docs, true) || $mime === 'application/octet-stream';    return false;}function move_uploaded_file_strict(array $file, string $destDir, string $projectRoot): string {    if (!isset($file['error']) || $file['error'] !== UPLOAD_ERR_OK) {        throw new RuntimeException('upload_error');    }    $tmp  = $file['tmp_name'];    $name = sanitize_filename($file['name'] ?? ('file_' . bin2hex(random_bytes(6))));    $ext  = pathinfo($name, PATHINFO_EXTENSION);    ensure_dir($destDir);    $base  = pathinfo($name, PATHINFO_FILENAME);    $final = $base . '_' . date('Ymd_His') . '_' . bin2hex(random_bytes(4)) . ($ext ? '.' . $ext : '');    $destFs = rtrim($destDir, '/\\') . DIRECTORY_SEPARATOR . $final;    if (!@move_uploaded_file($tmp, $destFs)) {        throw new RuntimeException('move_failed');    }    // proje köküne göre göreli yol    $rel = ltrim(str_replace($projectRoot, '', $destFs), '/\\');    return str_replace('\\', '/', $rel);}function safe_unlink_if_local(string $projectRoot, string $relPath, int $course_id, int $module_id): void {    $relPath = ltrim($relPath, '/\\');    $prefix = "uploads/course_{$course_id}/module_{$module_id}/";    if (!str_starts_with($relPath, $prefix)) return; // güvenlik: sadece bu klasör altını sil    $full = $projectRoot . '/' . $relPath;    if (is_file($full)) @unlink($full);}/** YouTube ID ayrıştırıcı (URL veya çıplak ID kabul eder) */function parse_youtube_id(?string $input): ?string {    if (!$input) return null;    $input = trim($input);    // çıplak ID (11–20 arası güvenli aralık)    if (preg_match('/^[A-Za-z0-9_-]{10,20}$/', $input)) {        return $input;    }    // URL gibi gelirse    $parts = @parse_url($input);    if (!$parts || empty($parts['host'])) return null;    $host = strtolower($parts['host']);    $path = $parts['path'] ?? '';    $query= [];    if (!empty($parts['query'])) parse_str($parts['query'], $query);    // youtu.be/<id>    if (strpos($host, 'youtu.be') !== false) {        $segments = array_values(array_filter(explode('/', $path)));        return $segments[0] ?? null;    }    if (strpos($host, 'youtube.com') !== false) {        // /watch?v=<id>        if (!empty($query['v'])) return $query['v'];        // /embed/<id>        if (preg_match('~/embed/([^/?#]+)~', $path, $m)) return $m[1];        // /shorts/<id>        if (preg_match('~/shorts/([^/?#]+)~', $path, $m)) return $m[1];    }    return null;}/** answers_payload → doğru şık index (1..5), yoksa 0 */function payload_to_correct_index(?string $payload): int {    if (!$payload) return 0;    $parts = explode('&', $payload);    foreach ($parts as $i => $p) {        if (str_ends_with($p, '=TRUE')) {            return $i + 1; // 1..N        }    }    return 0;}/** choices[]'i temizleyip 5 kolona pad eder; correct indexi ve explanation'ı üretir */function normalize_question(array $q): array {    $text = trim((string)($q['text'] ?? ''));    $explanation = trim((string)($q['explanation'] ?? ''));    if ($explanation !== '' && mb_strlen($explanation) > 1000) {        // backend de güvenli olsun: 1000'e kes        $explanation = mb_substr($explanation, 0, 1000);    }    $choices = array_values(array_filter(array_map(        fn($x) => trim((string)$x),        (array)($q['choices'] ?? [])    )));    $payload = (string)($q['answers_payload'] ?? '');    $correctIdx = payload_to_correct_index($payload); // 1..N    // ilk 5 dolu şık    $choices = array_slice($choices, 0, 5);    $answers = array_pad($choices, 5, null); // [a1..a5]    return [        'text'         => $text,        'explanation'  => $explanation,     // YENİ: açıklama        'answers'      => $answers,         // tam 5 eleman        'choicesCount' => count(array_filter($answers, fn($x)=> (string)$x !== '')),        'correct'      => $correctIdx,      // 1..N (N<=5), 0 ise yok    ];}// ---- Validate ----if ($_SERVER['REQUEST_METHOD'] !== 'POST') fail('Geçersiz istek yöntemi.');$module_id = isset($_POST['module_id']) ? (int)$_POST['module_id'] : 0;if ($module_id <= 0) fail('module_id eksik');$contents = $_POST['contents'] ?? [];           // contents[exist_XX|new_YY][...]$filesBag = $_FILES['contents'] ?? null;        // edit formunda üst key 'contents'if (!is_array($contents)) $contents = [];// ---- Ownership check & course_id ----$own = $pdo->prepare("    SELECT m.id AS module_id, m.course_id, c.team_db_id    FROM course_modules m    JOIN courses c ON c.id = m.course_id    WHERE m.id = ? AND c.team_db_id = ?");$own->execute([$module_id, $_SESSION['team_db_id']]);$modRow = $own->fetch(PDO::FETCH_ASSOC);if (!$modRow) fail('Bu modül üzerinde yetkiniz yok.', 403);$course_id = (int)$modRow['course_id'];$destDir   = $projectRoot . "/uploads/course_{$course_id}/module_{$module_id}";ensure_dir($destDir);// ---- Read existing rows ----$stmt = $pdo->prepare("SELECT id, type, data FROM module_contents WHERE module_id = ?");$stmt->execute([$module_id]);$existingRows = $stmt->fetchAll(PDO::FETCH_ASSOC);$currentIds = [];$oldDataById = [];foreach ($existingRows as $r) {    $currentIds[] = (int)$r['id'];    $oldDataById[(int)$r['id']] = ['type' => $r['type'], 'data' => $r['data']];}// ---- Build keep-set from POST ----$postedExistIds = [];foreach ($contents as $key => $cv) {    if (isset($cv['id']) && is_numeric($cv['id'])) {        $postedExistIds[] = (int)$cv['id'];    }}// ---- Compute deletions ----$toDelete = array_values(array_diff($currentIds, $postedExistIds));// ---- Transaction ----try {    $pdo->beginTransaction();    // 1) Delete removed rows (and their files optionally)    if (!empty($toDelete)) {        // 'quiz' satırları silinirse bağlı question'ı da sil        foreach ($toDelete as $delId) {            $info = $oldDataById[$delId] ?? null;            if (!$info) continue;            if ($info['type'] === 'quiz' && !empty($info['data'])) {                $qid = (int)$info['data'];                if ($qid > 0) {                    $dq = $pdo->prepare("DELETE FROM questions WHERE id=? AND module_id=?");                    $dq->execute([$qid, $module_id]);                }            } elseif (DELETE_FILES_ON_ROW_DELETE && $info['type'] !== 'text' && !empty($info['data'])) {                safe_unlink_if_local($projectRoot, $info['data'], $course_id, $module_id);            }        }        $in = implode(',', array_fill(0, count($toDelete), '?'));        $delStmt = $pdo->prepare("DELETE FROM module_contents WHERE module_id = ? AND id IN ($in)");        $delStmt->execute(array_merge([$module_id], $toDelete));    }    // 2) Upsert loop    foreach ($contents as $cKey => $cVal) {        $rawType  = $cVal['type'] ?? null;                  // 'text' | 'video' | 'document' | 'youtube' | 'question'        $sort     = isset($cVal['sort_order']) ? (int)$cVal['sort_order'] : 0;        $para     = $cVal['paragraph'] ?? null;             // text HTML        $existId  = isset($cVal['id']) ? (int)$cVal['id'] : 0;        $existing = $cVal['existing_file'] ?? null;         // eski dosya yolu        $ytRaw    = $cVal['youtube_url'] ?? null;           // youtube        $qBlock   = $cVal['question'] ?? null;              // soru bloğu (edit sayfasında gönderilir)        if (!$rawType) continue;        // DB tip eşlemesi        switch ($rawType) {            case 'document': $dbType = 'doc';     break;            case 'youtube':  $dbType = 'youtube'; break; // normalize            case 'question': $dbType = 'quiz';    break;            default:         $dbType = $rawType;        }        // --- file array (if any) ---        $fileArr = null;        if ($filesBag && isset($filesBag['name'][$cKey]['file'])) {            $fileArr = [                'name'     => $filesBag['name'][$cKey]['file'] ?? null,                'type'     => $filesBag['type'][$cKey]['file'] ?? null,                'tmp_name' => $filesBag['tmp_name'][$cKey]['file'] ?? null,                'error'    => $filesBag['error'][$cKey]['file'] ?? UPLOAD_ERR_NO_FILE,                'size'     => $filesBag['size'][$cKey]['file'] ?? 0,            ];        }        // === UPDATE path ===        if ($existId > 0) {            if ($dbType === 'text') {                $clean = trim((string)$para);                if ($clean === '') {                    $del = $pdo->prepare("DELETE FROM module_contents WHERE id = ? AND module_id = ?");                    $del->execute([$existId, $module_id]);                    continue;                }                $up = $pdo->prepare("UPDATE module_contents SET type='text', title=NULL, data=?, sort_order=? WHERE id=? AND module_id=?");                $up->execute([$para, $sort, $existId, $module_id]);            }            elseif ($dbType === 'youtube') {                $ytRaw = trim((string)$ytRaw);                if ($ytRaw === '') {                    $del = $pdo->prepare("DELETE FROM module_contents WHERE id = ? AND module_id = ?");                    $del->execute([$existId, $module_id]);                    continue;                }                $ytId = parse_youtube_id($ytRaw);                if (!$ytId) {                    // geçersizse satırı sil (istersen koru → continue)                    $del = $pdo->prepare("DELETE FROM module_contents WHERE id = ? AND module_id = ?");                    $del->execute([$existId, $module_id]);                    continue;                }                $canon = "https://youtu.be/" . $ytId;                $up = $pdo->prepare("UPDATE module_contents SET type='youtube', title=NULL, data=?, sort_order=? WHERE id=? AND module_id=?");                $up->execute([$canon, $sort, $existId, $module_id]);            }            elseif ($dbType === 'quiz') {                // Var olan quiz: questions kaydını güncelle, yoksa oluştur                $qNormalized = normalize_question((array)$qBlock);                $qText       = $qNormalized['text'];                $qExpl       = $qNormalized['explanation']; // YENİ                $answers     = $qNormalized['answers'];                $cnt         = $qNormalized['choicesCount'];                $correct     = (int)$qNormalized['correct']; // 1..5                $questionId  = isset($qBlock['id']) ? (int)$qBlock['id'] : 0;                // Geçersizse: satırı sil (front-end zaten validate ediyor)                if ($qText === '' || $cnt < 2 || $correct < 1 || $correct > $cnt) {                    // mevcut content + varsa question silinir                    $old = $oldDataById[$existId] ?? null;                    if ($old && $old['type'] === 'quiz' && !empty($old['data'])) {                        $qid = (int)$old['data'];                        if ($qid > 0) {                            $pdo->prepare("DELETE FROM questions WHERE id=? AND module_id=?")->execute([$qid, $module_id]);                        }                    }                    $pdo->prepare("DELETE FROM module_contents WHERE id = ? AND module_id = ?")->execute([$existId, $module_id]);                    continue;                }                if ($questionId > 0) {                    // UPDATE questions (explanation dahil)                    $upQ = $pdo->prepare("                        UPDATE questions                        SET text=?, explanation=?, answer1=?, answer2=?, answer3=?, answer4=?, answer5=?, correct_answer=?                        WHERE id=? AND module_id=?                    ");                    $upQ->execute([                        $qText, $qExpl,                        $answers[0], $answers[1], $answers[2], $answers[3], $answers[4],                        $correct,                        $questionId, $module_id                    ]);                    // module_contents type/data/sort normalize                    $pdo->prepare("UPDATE module_contents SET type='quiz', title=NULL, data=?, sort_order=? WHERE id=? AND module_id=?")                        ->execute([(string)$questionId, $sort, $existId, $module_id]);                } else {                    // Bağlı questionId yoksa yeni oluştur, content'i ona bağla (explanation dahil)                    $insQ = $pdo->prepare("                        INSERT INTO questions (module_id, text, explanation, answer1, answer2, answer3, answer4, answer5, correct_answer)                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)                    ");                    $insQ->execute([                        $module_id, $qText, $qExpl,                        $answers[0], $answers[1], $answers[2], $answers[3], $answers[4],                        $correct                    ]);                    $newQId = (int)$pdo->lastInsertId();                    $pdo->prepare("UPDATE module_contents SET type='quiz', title=NULL, data=?, sort_order=? WHERE id=? AND module_id=?")                        ->execute([(string)$newQId, $sort, $existId, $module_id]);                }            }            else {                // video/document                $newPath = null;  // yeni upload path                if ($fileArr && $fileArr['error'] === UPLOAD_ERR_OK) {                    $mime = detect_mime($fileArr['tmp_name']);                    $kind = ($dbType === 'video') ? 'video' : 'document';                    if (!is_allowed_mime($mime, $kind)) {                        throw new RuntimeException("Yasaklı dosya türü: $mime ($kind)");                    }                    $newPath = move_uploaded_file_strict($fileArr, $destDir, $projectRoot);                    // eskiyi sil                    if (DELETE_OLD_FILES_ON_REPLACE) {                        $old = $oldDataById[$existId]['data'] ?? null;                        if ($old && trim($old) !== '') {                            safe_unlink_if_local($projectRoot, $old, $course_id, $module_id);                        }                    }                } else {                    // yeni dosya yoksa eski path'i koru                    if ($existing && trim($existing) !== '') {                        $newPath = trim($existing);                    } else {                        // path yoksa -> satırı sil                        $del = $pdo->prepare("DELETE FROM module_contents WHERE id = ? AND module_id = ?");                        $del->execute([$existId, $module_id]);                        continue;                    }                }                $up = $pdo->prepare("UPDATE module_contents SET type=?, title=NULL, data=?, sort_order=? WHERE id=? AND module_id=?");                $up->execute([$dbType, $newPath, $sort, $existId, $module_id]);            }            // === INSERT path (new_*) ===        } else {            if ($dbType === 'text') {                $clean = trim((string)$para);                if ($clean === '') continue; // boş text ekleme                $ins = $pdo->prepare("INSERT INTO module_contents (module_id, type, title, data, sort_order) VALUES (?, 'text', NULL, ?, ?)");                $ins->execute([$module_id, $para, $sort]);            }            elseif ($dbType === 'youtube') {                $ytRaw = trim((string)$ytRaw);                if ($ytRaw === '') continue;                $ytId = parse_youtube_id($ytRaw);                if (!$ytId) continue;                $canon = "https://youtu.be/" . $ytId;                $ins = $pdo->prepare("INSERT INTO module_contents (module_id, type, title, data, sort_order) VALUES (?, 'youtube', NULL, ?, ?)");                $ins->execute([$module_id, $canon, $sort]);            }            elseif ($dbType === 'quiz') {                // Yeni soru: questions'a yaz + module_contents'e 'quiz' olarak bağla                $qNormalized = normalize_question((array)$qBlock);                $qText       = $qNormalized['text'];                $qExpl       = $qNormalized['explanation']; // YENİ                $answers     = $qNormalized['answers'];                $cnt         = $qNormalized['choicesCount'];                $correct     = (int)$qNormalized['correct']; // 1..5                if ($qText === '' || $cnt < 2 || $correct < 1 || $correct > $cnt) {                    // geçersizse ekleme (frontend zaten engelliyor)                    continue;                }                $insQ = $pdo->prepare("                    INSERT INTO questions (module_id, text, explanation, answer1, answer2, answer3, answer4, answer5, correct_answer)                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)                ");                $insQ->execute([                    $module_id, $qText, $qExpl,                    $answers[0], $answers[1], $answers[2], $answers[3], $answers[4],                    $correct                ]);                $qid = (int)$pdo->lastInsertId();                $insC = $pdo->prepare("                    INSERT INTO module_contents (module_id, type, title, data, sort_order)                    VALUES (?, 'quiz', NULL, ?, ?)                ");                $insC->execute([$module_id, (string)$qid, $sort]);            }            else {                $dataToStore = null;                if ($fileArr && $fileArr['error'] === UPLOAD_ERR_OK) {                    $mime = detect_mime($fileArr['tmp_name']);                    $kind = ($dbType === 'video') ? 'video' : 'document';                    if (!is_allowed_mime($mime, $kind)) {                        throw new RuntimeException("Yasaklı dosya türü: $mime ($kind)");                    }                    $dataToStore = move_uploaded_file_strict($fileArr, $destDir, $projectRoot);                } elseif ($existing && trim($existing) !== '') {                    $dataToStore = trim($existing);                } else {                    // yeni içerikte dosya yoksa ekleme                    continue;                }                $ins = $pdo->prepare("INSERT INTO module_contents (module_id, type, title, data, sort_order) VALUES (?, ?, NULL, ?, ?)");                $ins->execute([$module_id, $dbType, $dataToStore, $sort]);            }        }    }    $pdo->commit();    // modülü pending’e çek (opsiyonel)    $stat = $pdo->prepare("UPDATE course_modules SET status='pending' WHERE id=?");    $stat->execute([$module_id]);    // Not: edit sayfasının dosya adı sizde "edit_module.php" ise onu hedefleyin.    header('Location: edit_module_content.php?id=' . (int)$module_id . '&ok=1');    exit;} catch (Throwable $e) {    if ($pdo->inTransaction()) $pdo->rollBack();    http_response_code(500);    echo "Güncelleme sırasında hata: " . htmlspecialchars($e->getMessage());}